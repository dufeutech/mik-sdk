name: CI

on:
  push:
    branches: [main]
    paths-ignore:
      - "*.md"
      - "docs/**"
      - "LICENSE"
      - ".gitignore"
      - ".github/workflows/docs.yml"
      - ".github/workflows/release.yml"
      - ".vscode/**"
      - "examples/**"
  pull_request:
    branches: [main]
    paths-ignore:
      - "*.md"
      - "docs/**"
      - "LICENSE"
      - ".gitignore"
      - ".github/workflows/docs.yml"
      - ".github/workflows/release.yml"
      - ".vscode/**"
      - "examples/**"

# Cancel in-progress runs for the same branch/PR
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

# Minimal permissions - jobs override as needed
permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  RUSTFLAGS: -Dwarnings

jobs:
  # ============================================================================
  # Code Quality
  # ============================================================================

  format:
    name: Format
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      # Only format workspace crates (examples require generated bindings.rs)
      - run: cargo fmt --check -p mik-sdk -p mik-sdk-macros -p mik-sql -p mik-sql-macros

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
      - name: Clippy (all targets, all features)
        run: cargo clippy --workspace --exclude hello-world --exclude crud-api --exclude auth-api --exclude external-api --exclude resilient-api --all-targets --all-features -- -D warnings
      - name: Clippy (no default features)
        run: cargo clippy -p mik-sdk --no-default-features -- -D warnings

  # ============================================================================
  # Tests
  # ============================================================================

  test:
    name: Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@1.89
      - uses: Swatinem/rust-cache@v2
      - name: Run tests (all features)
        run: cargo test --workspace --exclude hello-world --exclude crud-api --exclude auth-api --exclude external-api --exclude resilient-api --all-features
      - name: Run tests (no default features)
        run: cargo test -p mik-sdk --no-default-features

  docs:
    name: Documentation
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Build documentation
        run: cargo doc --no-deps --workspace --exclude hello-world --exclude crud-api --exclude auth-api --exclude external-api --exclude resilient-api --all-features
        env:
          RUSTDOCFLAGS: -Dwarnings
      - name: Run doc tests
        run: cargo test --doc --workspace --exclude hello-world --exclude crud-api --exclude auth-api --exclude external-api --exclude resilient-api

  # ============================================================================
  # WASM & MSRV
  # ============================================================================

  wasm:
    name: WASM Build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@1.89
        with:
          targets: wasm32-wasip2
      - name: Cache cargo-component
        id: cache-cargo-component
        uses: actions/cache@v5
        with:
          path: ~/.cargo/bin/cargo-component
          key: cargo-component-0.18
      - name: Install cargo-component
        if: steps.cache-cargo-component.outputs.cache-hit != 'true'
        run: cargo install cargo-component --locked
      - uses: Swatinem/rust-cache@v2
      - name: Build bridge component
        run: cd mik-bridge && cargo component build --release
      - name: Build hello-world example
        run: cd examples/hello-world && cargo component build --release
      - name: Build crud-api example
        run: cd examples/crud-api && cargo component build --release

  e2e:
    name: E2E Tests (${{ matrix.runtime }})
    runs-on: ubuntu-latest
    timeout-minutes: 20
    # Only run on PRs and main branch pushes (skip feature branch pushes)
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    strategy:
      fail-fast: false
      matrix:
        runtime: [wasmtime, spin]
        # wasmcloud excluded - wash dev requires NATS and additional setup not available in CI
        # Run locally with: WASI_RUNTIME=wasmcloud cargo test -- --ignored
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@1.89
        with:
          targets: wasm32-wasip2
      - name: Cache WASM tools
        id: cache-wasm-tools
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/bin/cargo-component
            ~/.cargo/bin/wac
          key: wasm-tools-cargo-component-0.18-wac-0.6
      - name: Install cargo-component
        if: steps.cache-wasm-tools.outputs.cache-hit != 'true'
        run: cargo install cargo-component --locked
      - name: Install wac
        if: steps.cache-wasm-tools.outputs.cache-hit != 'true'
        run: cargo install wac-cli --locked
      # Runtime-specific setup
      - name: Setup wasmtime
        if: matrix.runtime == 'wasmtime'
        uses: bytecodealliance/actions/wasmtime/setup@v1
      - name: Cache Spin
        if: matrix.runtime == 'spin'
        id: cache-spin
        uses: actions/cache@v5
        with:
          path: ~/.spin
          key: spin-v3.0
      - name: Install Spin
        if: matrix.runtime == 'spin'
        uses: fermyon/actions/spin/setup@v1
        with:
          version: v3.0.0
      - uses: Swatinem/rust-cache@v2
      - name: Build bridge component
        run: cd mik-bridge && cargo component build --release
      - name: Build hello-world example
        run: cd examples/hello-world && cargo component build --release
      - name: Build crud-api example
        run: cd examples/crud-api && cargo component build --release
      - name: Compose components
        run: |
          mkdir -p tests-integration/fixtures
          wac plug mik-bridge/target/wasm32-wasip1/release/mik_bridge.wasm \
            --plug target/wasm32-wasip1/release/hello_world.wasm \
            -o tests-integration/fixtures/hello-world-service.wasm
          wac plug mik-bridge/target/wasm32-wasip1/release/mik_bridge.wasm \
            --plug target/wasm32-wasip1/release/crud_api.wasm \
            -o tests-integration/fixtures/crud-api-service.wasm
      - name: Run E2E tests
        run: |
          cd tests-integration
          WASI_RUNTIME=${{ matrix.runtime }} cargo test -- --ignored --nocapture
        env:
          RUST_BACKTRACE: 1

  msrv:
    name: MSRV (1.89)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@1.89
      - uses: Swatinem/rust-cache@v2
      - name: Check compilation
        run: cargo check --workspace --exclude hello-world --exclude crud-api --exclude auth-api --exclude external-api --exclude resilient-api

  # ============================================================================
  # Security & Compliance
  # ============================================================================

  security:
    name: Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      issues: write  # Required for rustsec to create advisories
    steps:
      - uses: actions/checkout@v6
      - uses: rustsec/audit-check@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

  deny:
    name: Cargo Deny
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v6
      - uses: EmbarkStudios/cargo-deny-action@v2

  semver:
    name: SemVer Check
    runs-on: ubuntu-latest
    timeout-minutes: 15
    # Only run on PRs to catch breaking changes before merge
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - uses: taiki-e/install-action@cargo-semver-checks
      - name: Check semver (mik-sdk)
        run: cargo semver-checks check-release -p mik-sdk
      - name: Check semver (mik-sql)
        run: cargo semver-checks check-release -p mik-sql
      - name: Check semver (mik-sdk-macros)
        run: cargo semver-checks check-release -p mik-sdk-macros
      - name: Check semver (mik-sql-macros)
        run: cargo semver-checks check-release -p mik-sql-macros

  # ============================================================================
  # Fuzz Testing
  # ============================================================================

  fuzz:
    name: Fuzz Targets
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@nightly
      - name: Cache cargo-fuzz
        id: cache-cargo-fuzz
        uses: actions/cache@v5
        with:
          path: ~/.cargo/bin/cargo-fuzz
          key: cargo-fuzz-0.12
      - name: Install cargo-fuzz
        if: steps.cache-cargo-fuzz.outputs.cache-hit != 'true'
        run: cargo install cargo-fuzz --locked
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: mik-sdk/fuzz
      - name: Build fuzz targets
        working-directory: mik-sdk/fuzz
        run: cargo +nightly fuzz build
      - name: Run fuzz targets briefly
        working-directory: mik-sdk/fuzz
        run: |
          for target in $(cargo +nightly fuzz list); do
            echo "Running $target for 10 seconds..."
            cargo +nightly fuzz run "$target" -- -max_total_time=10 || true
          done

  # ============================================================================
  # Benchmarks
  # ============================================================================

  benchmark:
    name: Benchmark Compilation
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Compile benchmarks (mik-sdk)
        run: cargo bench -p mik-sdk --no-run
      - name: Compile benchmarks (mik-sql)
        run: cargo bench -p mik-sql --no-run

  # ============================================================================
  # Coverage
  # ============================================================================

  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@1.89
        with:
          components: llvm-tools-preview
      - uses: taiki-e/install-action@cargo-llvm-cov
      - uses: Swatinem/rust-cache@v2
      - name: Generate coverage report
        run: cargo llvm-cov --all-features --workspace --exclude hello-world --exclude crud-api --exclude auth-api --exclude external-api --exclude resilient-api --lcov --output-path lcov.info
      # Note: CODECOV_TOKEN secret must be added to repo settings at:
      # Settings > Secrets and variables > Actions > New repository secret
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: lcov.info
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # ============================================================================
  # Quality Gate
  # ============================================================================

  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [format, clippy, test, docs, wasm, e2e, msrv, security, deny]
    if: always()
    steps:
      - name: Check all jobs passed
        run: |
          # E2E may be skipped on feature branch pushes - that's OK
          e2e_ok="${{ needs.e2e.result == 'success' || needs.e2e.result == 'skipped' }}"

          if [[ "${{ needs.format.result }}" != "success" ]] || \
             [[ "${{ needs.clippy.result }}" != "success" ]] || \
             [[ "${{ needs.test.result }}" != "success" ]] || \
             [[ "${{ needs.docs.result }}" != "success" ]] || \
             [[ "${{ needs.wasm.result }}" != "success" ]] || \
             [[ "$e2e_ok" != "true" ]] || \
             [[ "${{ needs.msrv.result }}" != "success" ]] || \
             [[ "${{ needs.security.result }}" != "success" ]] || \
             [[ "${{ needs.deny.result }}" != "success" ]]; then
            echo "One or more quality checks failed"
            exit 1
          fi
          echo "All quality checks passed!"
